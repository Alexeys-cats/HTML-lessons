name: Feature Branch Preview

on:
  push:
    branches-ignore:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Get branch name
        id: branch-name
        uses: tj-actions/branch-names@v7

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build:ci
        env:
          VITE_BASE_PATH: /HTML-lessons/preview/${{ steps.branch-name.outputs.current_branch }}

      - name: Update base path in HTML
        run: |
          # –°–æ–∑–¥–∞–µ–º .nojekyll –¥–ª—è GitHub Pages
          touch dist/.nojekyll
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–π –ø—É—Ç—å –≤ index.html, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
          BRANCH_PATH=$(echo ${{ steps.branch-name.outputs.current_branch }} | sed 's/\//-/g')
          sed -i "s|<base href=\"/HTML-lessons/\">|<base href=\"/HTML-lessons/preview/${BRANCH_PATH}/\">|" dist/index.html || true

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist
          branch: gh-pages
          target-folder: preview/${{ steps.branch-name.outputs.current_branch }}
          clean: true

      - name: Find Pull Request
        uses: jwalton/gh-find-current-pr@v1
        id: find-pr
        if: github.event_name == 'push' || github.event_name == 'pull_request'
        with:
          state: open

      - name: Add or update comment with preview link
        if: steps.find-pr.outputs.number
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          number: ${{ steps.find-pr.outputs.number }}
          header: preview
          message: |
            üöÄ **–ü—Ä–µ–≤—å—é —Ñ–∏—á–∞-—Å—Ç–µ–Ω–¥–∞ –≥–æ—Ç–æ–≤–æ!**
            
            –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–æ–∂–Ω–æ –ø–æ —Å—Å—ã–ª–∫–µ: [–§–∏—á–∞-—Å—Ç–µ–Ω–¥ –Ω–∞ GitHub Pages](https://${{ github.repository_owner }}.github.io/HTML-lessons/preview/${{ steps.branch-name.outputs.current_branch }}/)
            
            _–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–æ –∏–∑ –≤–µ—Ç–∫–∏: ${{ steps.branch-name.outputs.current_branch }}_
