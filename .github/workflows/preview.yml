name: Feature Branch Preview

on:
  push:
    branches-ignore:
      - main # –ò—Å–∫–ª—é—á–∞–µ–º main, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–∞–π–ø–ª–∞–π–Ω–µ
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write # –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–∞ GitHub Pages
  pull-requests: write # –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è PR

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Get branch name
        id: branch-name
        uses: tj-actions/branch-names@v7

      # –°–æ–∑–¥–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–º—è –≤–µ—Ç–∫–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ URL
      - name: Create safe branch name
        id: safe-branch-name
        run: |
          BRANCH="${{ steps.branch-name.outputs.current_branch }}"
          SAFE_BRANCH=$(echo $BRANCH | sed 's/\//-/g')
          echo "safe_branch=${SAFE_BRANCH}" >> $GITHUB_OUTPUT
          echo "Original branch: ${BRANCH}"
          echo "Safe branch name: ${SAFE_BRANCH}"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npx vite build --base=/HTML-lessons/preview/${{ steps.safe-branch-name.outputs.safe_branch }}/

      # –î–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–π –ø—É—Ç—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±–æ—Ä–∫–∏
      - name: Update base path in HTML
        run: |
          # –°–æ–∑–¥–∞–µ–º .nojekyll –¥–ª—è GitHub Pages
          touch dist/.nojekyll
          
          # –°–æ–∑–¥–∞–µ–º index.html –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç (—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞)
          [ -f dist/index.html ] || echo "<html><body>Redirecting...</body></html>" > dist/index.html
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–π –ø—É—Ç—å –≤ index.html, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
          SAFE_BRANCH="${{ steps.safe-branch-name.outputs.safe_branch }}"
          sed -i "s|<base href=\"/HTML-lessons/\">|<base href=\"/HTML-lessons/preview/${SAFE_BRANCH}/\">|" dist/index.html || true
          
          echo "Checking dist directory contents:"
          ls -la dist/

      # –î–µ–ø–ª–æ–π –Ω–∞ GitHub Pages –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –≤–µ—Ç–∫–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–º—è)
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist
          branch: gh-pages
          target-folder: preview/${{ steps.safe-branch-name.outputs.safe_branch }}
          clean: true # –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ —Ç–µ–∫—É—â–µ–π –≤–µ—Ç–∫–∏

      # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ PR —Å —Å—Å—ã–ª–∫–æ–π –Ω–∞ —Ñ–∏—á–∞-—Å—Ç–µ–Ω–¥
      - name: Find Pull Request
        uses: jwalton/gh-find-current-pr@v1
        id: find-pr
        if: github.event_name == 'push' || github.event_name == 'pull_request'
        with:
          state: open

      - name: Add or update comment with preview link
        if: steps.find-pr.outputs.number
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          number: ${{ steps.find-pr.outputs.number }}
          header: preview
          message: |
            üöÄ **–ü—Ä–µ–≤—å—é —Ñ–∏—á–∞-—Å—Ç–µ–Ω–¥–∞ –≥–æ—Ç–æ–≤–æ!**
            
            –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–æ–∂–Ω–æ –ø–æ —Å—Å—ã–ª–∫–µ: [–§–∏—á–∞-—Å—Ç–µ–Ω–¥ –Ω–∞ GitHub Pages](https://${{ github.repository_owner }}.github.io/HTML-lessons/preview/${{ steps.safe-branch-name.outputs.safe_branch }}/#/)
            
            _–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–æ –∏–∑ –≤–µ—Ç–∫–∏: ${{ steps.branch-name.outputs.current_branch }}_
